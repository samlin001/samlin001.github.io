<!DOCTYPE html>
<html>
  <head>
    <title>WebUSB test app</title>
  </head>
  <body>
    <script>
      var webUsbDevice = {};
      var connectedUsbDeviceFilters = [];
      var connectedUsbDeviceInfo = [];

      (function() {
        webUsbDevice.getDevices = function() {
          return navigator.usb.getDevices().then(devices => {
            return devices.map(device => new webUsbDevice.Device(device));
          });
        };

        webUsbDevice.requestDevice = function() {
          return navigator.usb.requestDevice({ 'filters': connectedUsbDeviceFilters })
            .then(device => new webUsbDevice.Device(device));
        };

        webUsbDevice.Device = function(device) {
          this.device_ = device;
        };

        webUsbDevice.Device.prototype.connect = function() {
          return this.device_.open()
            .then(() => {
              for (let i = 0; i < this.device_.configurations.length; i++) {
                console.log("configrating: ", i);
                this.device_.selectConfiguration(i+1)
                  .then(() => {
                    for (let j = 0; j < this.device_.configurations[i].interfaces.length; j++) {
                      console.log("claiming I/F: ", j);
                      this.device_.claimInterface(j)
                        .then(() => { alert("Connected!");})
                        .catch(err => alert(err.message));
                    }
                  })
                  .catch(err => alert(err.message));
              }
            })
            .catch(err => alert(err.message));
        };

        webUsbDevice.Device.prototype.disconnect = function() {
          return this.device_.close();
        };
      })();

      // Creates a connected device filter to request device
      document.addEventListener('DOMContentLoaded', async () => {
          // Always filter these vendor IDs
          // Google
          connectedUsbDeviceFilters.push({'vendorId': 0x18D1});
          // ASUS
          connectedUsbDeviceFilters.push({'vendorId': 0x0B05});
          // Apple
          connectedUsbDeviceFilters.push({'vendorId': 0x05AC});
          // Microchip
          connectedUsbDeviceFilters.push({'vendorId': 0x0424});
          connectedUsbDeviceFilters.push({'vendorId': 0x04D8});
          // Cambridge Silicon Radio, Ltd
          connectedUsbDeviceFilters.push({'vendorId': 0x0A12});

          // https://developer.chrome.com/articles/usb/
          let devices = await navigator.usb.getDevices();
          devices.forEach(device => {
            connectedUsbDeviceFilters.push({'vendorId': device.vendorId});

            // https://wicg.github.io/webusb/#usbdevice
            connectedUsbDeviceInfo.push(device.manufacturerName);
            connectedUsbDeviceInfo.push(device.productName);
            connectedUsbDeviceInfo.push("vendorId=");
            connectedUsbDeviceInfo.push(device.vendorId);
            connectedUsbDeviceInfo.push('productId=');
            connectedUsbDeviceInfo.push(device.productId);
            connectedUsbDeviceInfo.push('\n');
          });
          alert(connectedUsbDeviceInfo.join(" "));
        });

      window.onload = _ => {
        document.querySelector("#connectBtn").onclick = function() {
          webUsbDevice.requestDevice()
            .then(usbDevice => {
              usbDevice.connect();
            })
            .catch(err => { console.error(err); });
        }
      }

    </script>
    <button id="connectBtn" style="visibility: initial">Connect to a usb host device</button>
    <ul>
      <li>chrome://usb-internal</li>
      <li>chrome://device-log</li>
      <li><a href="https://developer.chrome.com/articles/usb/">Access USB Devices on the Web</a></li>
      <li><a href="https://wicg.github.io/webusb/#usbinterface-interface">WebUSB USBInterface isProtectedClass</a></li>
      <li><a href="https://www.usb.org/defined-class-codes">USB device class codes</a></li>
    </ul>
  </body>
</html>
